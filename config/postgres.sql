SECTION 9: TABLES SQL REQUISES (MISE A JOUR) ================================================================================ -- Table L2/L3 Memory CREATE TABLE IF NOT EXISTS conversation_context ( id SERIAL PRIMARY KEY, conversation_id VARCHAR(100) NOT NULL, tenant_id VARCHAR(50) NOT NULL, entities_json JSONB DEFAULT '{}', last_intent VARCHAR(50), updated_at TIMESTAMP DEFAULT NOW(), UNIQUE(conversation_id, tenant_id) ); CREATE INDEX IF NOT EXISTS idx_conv_ctx_lookup ON conversation_context(conversation_id, tenant_id); -- Table RLHF CREATE TABLE IF NOT EXISTS rlhf_training_data ( id SERIAL PRIMARY KEY, conversation_id VARCHAR(100) NOT NULL UNIQUE, query TEXT NOT NULL, response TEXT NOT NULL, feedback_score FLOAT CHECK (feedback_score >= 0 AND feedback_score <= 1), feedback_type VARCHAR(50) CHECK (feedback_type IN ('implicit', 'explicit')), reasoning_path JSONB, is_good_example BOOLEAN DEFAULT false, is_bad_example BOOLEAN DEFAULT false, needs_review BOOLEAN DEFAULT false, created_at TIMESTAMP DEFAULT NOW() ); CREATE INDEX IF NOT EXISTS idx_rlhf_quality ON rlhf_training_data(is_good_example, is_bad_example) WHERE is_good_example = true OR is_bad_example = true; -- Table Community Summaries CREATE TABLE IF NOT EXISTS community_summaries ( id SERIAL PRIMARY KEY, tenant_id VARCHAR(50) NOT NULL, entity_names TEXT[] NOT NULL, summary TEXT NOT NULL, relevance_score FLOAT DEFAULT 0.5, algorithm VARCHAR(50) DEFAULT 'louvain', created_at TIMESTAMP DEFAULT NOW(), updated_at TIMESTAMP DEFAULT NOW() ); CREATE INDEX IF NOT EXISTS idx_community_entities ON community_summaries USING GIN(entity_names); -- Table Entities (pour enrichissement) CREATE TABLE IF NOT EXISTS entities ( id SERIAL PRIMARY KEY, name VARCHAR(255) NOT NULL, type VARCHAR(50) NOT NULL, tenant_id VARCHAR(50) NOT NULL, confidence FLOAT DEFAULT 0.5, created_at TIMESTAMP DEFAULT NOW(), UNIQUE(name, tenant_id) ); -- Modifications table documents existante ALTER TABLE documents ADD COLUMN IF NOT EXISTS is_obsolete BOOLEAN DEFAULT FALSE; ALTER TABLE documents ADD COLUMN IF NOT EXISTS obsoleted_at TIMESTAMP; ALTER TABLE documents ADD COLUMN IF NOT EXISTS superseded_by VARCHAR(100); ALTER TABLE documents ADD COLUMN IF NOT EXISTS version INT DEFAULT 1; ALTER TABLE documents ADD COLUMN IF NOT EXISTS summary_context TEXT; ALTER TABLE documents ADD COLUMN IF NOT EXISTS quality_score FLOAT DEFAULT 0.5; ALTER TABLE documents ADD COLUMN IF NOT EXISTS parent_id VARCHAR(100); ALTER TABLE documents ADD COLUMN IF NOT EXISTS parent_filename VARCHAR(500); ALTER TABLE documents ADD COLUMN IF NOT EXISTS chunk_method VARCHAR(50); CREATE INDEX IF NOT EXISTS idx_docs_obsolete ON documents(is_obsolete, tenant_id) WHERE is_obsolete = false; CREATE INDEX IF NOT EXISTS idx_docs_parent ON documents(parent_filename, version) WHERE is_obsolete = false;
