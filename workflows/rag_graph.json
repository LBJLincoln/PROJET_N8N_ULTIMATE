{
  "name": "Fusion B++ Ultimate - WF3: Graph RAG V3.0 (SOTA 2026) HARDENED",
  "nodes": [
    {
      "parameters": {},
      "id": "sub-workflow-trigger",
      "name": "Sub-Workflow Trigger",
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1,
      "position": [-900, 140]
    },
    {
      "parameters": {
        "jsCode": "// Init OpenTelemetry trace - HARDENED
const input = $input.first().json || {};
const query = String(input.query || '').substring(0, 2000).trim();

if (!query) {
  throw new Error('VALIDATION_ERROR: query is required');
}

return [{
  json: {
    trace_id: input.trace_id || 'trc-' + Math.random().toString(36).substring(2, 15),
    parent_span_id: 'span-' + Math.random().toString(36).substring(2, 10),
    start_time: new Date().toISOString(),
    status: 'INITIALIZED',
    query: query,
    user_context: input.user_context || { groups: ['guest'], tenant_id: 'default' }
  }
}];"
      },
      "id": "4587afcd-6c26-4cd3-a8e6-16a50d9df1a8",
      "name": "OTEL Init",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-700, 140]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $vars.LLM_API_URL || 'https://api.openai.com/v1/chat/completions' }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={
  "model": "{{ $vars.HYDE_MODEL || 'gpt-4o' }}",
  "messages": [
    {
      "role": "system",
      "content": "Tu generes un document hypothetique qui repondrait parfaitement a la question. Ce document sera utilise pour la recherche semantique. Format: texte dense, factuel, 200-300 mots. Extrais aussi les entites cles en JSON: {\\"hyde_document\\": string, \\"entities\\": [{\\"name\\": string, \\"type\\": string}]}"
    },
    {
      "role": "user",
      "content": "{{ $json.query }}"
    }
  ],
  "temperature": 0.7,
  "max_tokens": 800,
  "response_format": { "type": "json_object" }
}",
        "options": {
          "timeout": 25000
        }
      },
      "id": "26180b5a-958f-46c4-9df4-a0af13ada653",
      "name": "WF3: HyDE & Entity Extraction",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [-480, 140],
      "credentials": {
        "httpHeaderAuth": {
          "id": "LLM_API_CREDENTIAL_ID",
          "name": "OpenAI API Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// P0: Parameterized Neo4j query for Graph RAG - PATCH 3.1: N+2 Traversal
const initData = $node['OTEL Init'].json;
let hydeResponse = {};
try {
  hydeResponse = JSON.parse($json.choices?.[0]?.message?.content || '{}');
} catch (e) {
  hydeResponse = { entities: [], hyde_document: '' };
}

const hydeEntities = hydeResponse.entities || [];

// Strict validation of entity names
const validEntities = hydeEntities
  .filter(e => e && typeof e.name === 'string')
  .map(e => e.name.replace(/[^a-zA-Z0-9\\-_\\s]/g, '').substring(0, 100))
  .slice(0, 20);

if (validEntities.length === 0) {
  return { skip_neo4j: true, reason: 'No valid entities extracted', hyde_document: hydeResponse.hyde_document };
}

// PATCH 3.1: Traversal N+2
const cypherQuery = `
MATCH path = (n)-[r*1..2]-(m)
WHERE n.name IN $entity_names
  AND n.tenant_id = $tenant_id
  AND ANY(g IN n.allowed_groups WHERE g IN $user_groups)
RETURN n, r, m, 
       CASE WHEN length(path) = 1 THEN 1 ELSE 2 END as distance
ORDER BY distance ASC
LIMIT 100
`;

return {
  skip_neo4j: false,
  query: cypherQuery,
  parameters: {
    entity_names: validEntities,
    tenant_id: initData.user_context.tenant_id,
    user_groups: initData.user_context.groups
  },
  hyde_document: hydeResponse.hyde_document,
  entities: validEntities
};"
      },
      "id": "neo4j-query-builder",
      "name": "Neo4j Query Builder",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [-260, 20]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $vars.NEO4J_URL }}/db/neo4j/tx/commit",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpBasicAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={
  "statements": [{
    "statement": {{ JSON.stringify($json.query) }},
    "parameters": {{ JSON.stringify($json.parameters) }}
  }]
}",
        "options": {
          "timeout": 10000
        }
      },
      "id": "08974b77-c145-47aa-8b7b-fcc525776950",
      "name": "Shield #4: Neo4j Guardian Traversal",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [-40, 20],
      "onError": "continueErrorOutput",
      "credentials": {
        "httpBasicAuth": {
          "id": "NEO4J_CREDENTIAL_ID",
          "name": "Neo4j Basic Auth"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $vars.PINECONE_URL }}/query",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={
  "vector": {{ JSON.stringify($node['OTEL Init'].json.vector || [0.1]) }},
  "topK": 100,
  "filter": {
    "tenant_id": "{{ $node['OTEL Init'].json.user_context.tenant_id }}",
    "allowed_groups": { "$in": {{ JSON.stringify($node['OTEL Init'].json.user_context.groups) }} }
  },
  "includeMetadata": true
}",
        "options": {
          "timeout": 15000
        }
      },
      "id": "d2ad87cb-4ad6-4fab-a32e-8822074605ac",
      "name": "WF3: Pinecone HyDE Search",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [-40, 260],
      "onError": "continueErrorOutput",
      "credentials": {
        "httpHeaderAuth": {
          "id": "PINECONE_API_CREDENTIAL_ID",
          "name": "Pinecone API Key"
        }
      }
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT summary, relevance_score, entity_names FROM community_summaries WHERE entity_names && ARRAY[$1::text[]] AND tenant_id = $2 ORDER BY relevance_score DESC LIMIT 5",
        "options": {}
      },
      "id": "community-summaries-fetch",
      "name": "Community Summaries Fetch",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2.4,
      "position": [180, 20],
      "onError": "continueErrorOutput",
      "credentials": {
        "postgres": {
          "id": "POSTGRES_CREDENTIAL_ID",
          "name": "Postgres Production"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// PATCH 3.3: Merge Graph + Vector + Community enrichissement
const neo4jData = $items('Shield #4: Neo4j Guardian Traversal') || [];
const pineconeData = $items('WF3: Pinecone HyDE Search') || [];
const communityData = $items('Community Summaries Fetch') || [];

// Extract relationships from Neo4j
const relationships = neo4jData
  .filter(item => item.json?.results?.[0]?.data)
  .flatMap(item => item.json.results[0].data || [])
  .map(row => ({
    source: row.row?.[0]?.name || 'unknown',
    target: row.row?.[2]?.name || 'unknown',
    type: row.row?.[1]?.[0]?.type || 'RELATED_TO',
    distance: row.row?.[3] || 1
  }))
  .slice(0, 50);

// Extract vector details
const vectorDetails = pineconeData
  .filter(item => item.json?.matches)
  .flatMap(item => item.json.matches || [])
  .map(match => ({
    content: match.metadata?.content || '',
    score: match.score || 0
  }))
  .slice(0, 20);

// Extract community trends
const communityTrends = communityData
  .map(item => ({
    summary: item.json?.summary || '',
    relevance: item.json?.relevance_score || 0,
    entities: item.json?.entity_names || []
  }))
  .slice(0, 5);

// PATCH 3.3: Three-dimensional enriched context
return {
  enriched_context: {
    relationships: relationships,
    trends: communityTrends,
    details: vectorDetails
  },
  relationship_count: relationships.length,
  community_count: communityTrends.length,
  detail_count: vectorDetails.length
};"
      },
      "id": "merge-graph-vector-community",
      "name": "Merge Graph + Vector + Community",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [200, 140]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $vars.RERANKER_API_URL || 'https://api.cohere.ai/v1/rerank' }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={
  "model": "{{ $vars.RERANKER_MODEL || 'rerank-multilingual-v3.0' }}",
  "query": "{{ $node['OTEL Init'].json.query }}",
  "documents": {{ JSON.stringify($json.enriched_context.details.map(d => d.content)) }},
  "top_n": 10
}",
        "options": {
          "timeout": 15000
        }
      },
      "id": "cohere-reranker",
      "name": "WF3: Cohere Reranker",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [400, 140],
      "onError": "continueErrorOutput",
      "credentials": {
        "httpHeaderAuth": {
          "id": "COHERE_API_CREDENTIAL_ID",
          "name": "Cohere API Key"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Reranker fallback handler
const rerankedResults = $json.results || [];
const contextData = $node['Merge Graph + Vector + Community'].json;

return {
  reranked_results: rerankedResults,
  enriched_context: contextData.enriched_context,
  fallback: rerankedResults.length === 0
};"
      },
      "id": "reranker-fallback",
      "name": "Reranker Fallback Handler",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [600, 140]
    },
    {
      "parameters": {
        "jsCode": "// Token budgeting & map-reduce
return $json;"
      },
      "id": "token-budgeting",
      "name": "JS: Token Budgeting & Map-Reduce",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [800, 140]
    },
    {
      "parameters": {
        "jsCode": "// Response formatter
return {
  status: 'SUCCESS',
  trace_id: $node['OTEL Init'].json.trace_id,
  response: $json
};"
      },
      "id": "response-formatter",
      "name": "Response Formatter",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1000, 140]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $vars.OTEL_COLLECTOR_URL || 'https://otel-collector.internal' }}/v1/traces",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={
  "traceId": "{{ $json.trace_id }}",
  "spanName": "graph_rag_complete",
  "status": "{{ $json.status }}"
}",
        "options": {
          "timeout": 5000
        }
      },
      "id": "export-trace",
      "name": "Shield #9: Export Trace",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [1200, 140]
    }
  ],
  "connections": {
    "Sub-Workflow Trigger": {
      "main": [[{ "node": "OTEL Init", "type": "main", "index": 0 }]]
    },
    "OTEL Init": {
      "main": [[{ "node": "WF3: HyDE & Entity Extraction", "type": "main", "index": 0 }]]
    },
    "WF3: HyDE & Entity Extraction": {
      "main": [[{ "node": "Neo4j Query Builder", "type": "main", "index": 0 }]]
    },
    "Neo4j Query Builder": {
      "main": [
        [{ "node": "Shield #4: Neo4j Guardian Traversal", "type": "main", "index": 0 }],
        [{ "node": "Community Summaries Fetch", "type": "main", "index": 0 }]
      ]
    },
    "Shield #4: Neo4j Guardian Traversal": {
      "main": [[{ "node": "Merge Graph + Vector + Community", "type": "main", "index": 0 }]]
    },
    "WF3: Pinecone HyDE Search": {
      "main": [[{ "node": "Merge Graph + Vector + Community", "type": "main", "index": 0 }]]
    },
    "Community Summaries Fetch": {
      "main": [[{ "node": "Merge Graph + Vector + Community", "type": "main", "index": 0 }]]
    },
    "Merge Graph + Vector + Community": {
      "main": [[{ "node": "WF3: Cohere Reranker", "type": "main", "index": 0 }]]
    },
    "WF3: Cohere Reranker": {
      "main": [[{ "node": "Reranker Fallback Handler", "type": "main", "index": 0 }]]
    },
    "Reranker Fallback Handler": {
      "main": [[{ "node": "JS: Token Budgeting & Map-Reduce", "type": "main", "index": 0 }]]
    },
    "JS: Token Budgeting & Map-Reduce": {
      "main": [[{ "node": "Response Formatter", "type": "main", "index": 0 }]]
    },
    "Response Formatter": {
      "main": [[{ "node": "Shield #9: Export Trace", "type": "main", "index": 0 }]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveManualExecutions": true,
    "callerPolicy": "workflowsFromSameOwner"
  },
  "active": true,
  "meta": {
    "instanceId": "production-sota-2026"
  }
}
